#!/bin/sh

PATH=/usr/bin:/usr/sbin
export PATH

problem()
{
   printf "\n\nEncountered a problem!\n"
   printf "Dropping you to a shell.\n\n"
   printf "Available devices:\n"
   ls -la /dev/sd* /dev/vd* /dev/xvd* /dev/nvme* 2>/dev/null || true
   printf "\n"
   sh
}

no_device()
{
   printf "The device %s, which is supposed to contain the\n" $1
   printf "root file system, does not exist.\n"
   printf "Please fix this problem and exit this shell.\n\n"
}

no_mount()
{
   printf "Could not mount device %s\n" $1
   printf "Sleeping forever. Please reboot and fix the kernel command line.\n\n"
   printf "Maybe the device is formatted with an unsupported file system?\n\n"
   printf "Or maybe filesystem type autodetection went wrong, in which case\n"
   printf "you should add the rootfstype=... parameter to the kernel command line.\n\n"
   printf "Available partitions:\n"
}

# Fungsi untuk mencari rootfs.squashfs di berbagai lokasi
find_rootfs_squashfs()
{
    printf "\n=== Searching for rootfs.squashfs ===\n"
    
    # Buat directory untuk mencoba mount
    mkdir -p /mnt/try
    
    # Daftar device yang akan dicoba
    devices=""
    for pattern in /dev/sd* /dev/vd* /dev/xvd* /dev/nvme* /dev/mmcblk*; do
        [ -b "$pattern" ] && devices="$devices $pattern"
    done
    
    if [ -z "$devices" ]; then
        echo "No block devices found!"
        return 1
    fi
    
    echo "Checking devices: $devices"
    
    for dev in $devices; do
        printf "\nTrying device: %s\n" "$dev"
        
        # Coba mount device
        if mount -n -t auto -o ro "$dev" /mnt/try 2>/dev/null; then
            echo "Successfully mounted $dev"
            
            # Lokasi-lokasi yang mungkin berisi rootfs.squashfs
            locations="/sources/ /live/ /casper/ / /rootfs/ /system/ /os/ squashfs/"
            
            for location in $locations; do
                squashfs_path="/mnt/try${location}rootfs.squashfs"
                if [ -f "$squashfs_path" ]; then
                    echo "✓ Found: $squashfs_path"
                    
                    # Buat directory root
                    mkdir -p /.root
                    
                    # Mount squashfs
                    echo "Mounting squashfs..."
                    if mount -t squashfs -o loop "$squashfs_path" /.root; then
                        echo "Successfully mounted squashfs"
                        umount /mnt/try 2>/dev/null
                        rm -rf /mnt/try
                        return 0
                    else
                        echo "Failed to mount squashfs"
                    fi
                fi
                
                # Coba nama file alternatif
                for alt_name in filesystem.squashfs system.squashfs root.squashfs live.squashfs; do
                    alt_path="/mnt/try${location}${alt_name}"
                    if [ -f "$alt_path" ]; then
                        echo "✓ Found (alternate): $alt_path"
                        mkdir -p /.root
                        if mount -t squashfs -o loop "$alt_path" /.root; then
                            echo "Successfully mounted $alt_name"
                            umount /mnt/try 2>/dev/null
                            rm -rf /mnt/try
                            return 0
                        fi
                    fi
                done
            done
            
            # Coba cari file squashfs di mana saja
            echo "Searching for any squashfs files..."
            find_result=$(find /mnt/try -name "*.squashfs" -type f 2>/dev/null | head -5)
            if [ -n "$find_result" ]; then
                echo "Found squashfs files:"
                echo "$find_result"
                for squashfs in $find_result; do
                    echo "Trying: $squashfs"
                    mkdir -p /.root
                    if mount -t squashfs -o loop "$squashfs" /.root; then
                        echo "Successfully mounted: $squashfs"
                        umount /mnt/try 2>/dev/null
                        rm -rf /mnt/try
                        return 0
                    fi
                done
            fi
            
            umount /mnt/try 2>/dev/null
        else
            echo "Failed to mount $dev"
        fi
    done
    
    rm -rf /mnt/try
    echo "ERROR: Could not find rootfs.squashfs on any device!"
    return 1
}

do_mount_root()
{
   mkdir -p /.root
   [ -n "$rootflags" ] && rootflags="$rootflags,"
   rootflags="$rootflags$ro"

   case "$root" in
      /dev/*    ) device=$root ;;
      UUID=*    ) eval $root; device="/dev/disk/by-uuid/$UUID" ;;
      PARTUUID=*) eval $root; device="/dev/disk/by-partuuid/$PARTUUID" ;;
      LABEL=*   ) eval $root; device="/dev/disk/by-label/$LABEL" ;;
      "AUTO"    ) device="auto" ;;
      ""        ) device="auto" ;;
   esac

   # Jika device adalah "auto", cari rootfs.squashfs
   if [ "$device" = "auto" ]; then
       echo "Auto-detecting root filesystem..."
       if find_rootfs_squashfs; then
           echo "Auto-detection successful!"
           return 0
       else
           echo "Auto-detection failed!"
           problem
       fi
   fi

   # Mount device biasa
   while [ ! -b "$device" ] ; do
       no_device $device
       problem
   done

   echo "Mounting $device as root..."
   if ! mount -n -t "$rootfstype" -o "$rootflags" "$device" /.root ; then
       no_mount $device
       cat /proc/partitions
       problem
   else
       echo "Successfully mounted device $root"
   fi
}

do_try_resume()
{
   case "$resume" in
      UUID=* ) eval $resume; resume="/dev/disk/by-uuid/$UUID"  ;;
      LABEL=*) eval $resume; resume="/dev/disk/by-label/$LABEL" ;;
   esac

   if $noresume || ! [ -b "$resume" ]; then return; fi

   ls -lH "$resume" | ( read x x x x maj min x
       echo -n ${maj%,}:$min > /sys/power/resume )
}

init=/sbin/init
root=
rootdelay=
rootfstype=auto
ro="ro"
rootflags=
device=
resume=
noresume=false

echo "=== Initializing initramfs ==="
echo "Mounting essential filesystems..."

mount -n -t devtmpfs devtmpfs /dev 2>/dev/null || echo "devtmpfs already mounted"
mount -n -t proc     proc     /proc
mount -n -t sysfs    sysfs    /sys
mount -n -t tmpfs    tmpfs    /run

# Buat directory penting
mkdir -p /dev/pts /dev/shm /mnt /media /proc /sys /run

read -r cmdline < /proc/cmdline
echo "Kernel command line: $cmdline"

for param in $cmdline ; do
  case $param in
    init=*      ) init=${param#init=}             ;;
    root=*      ) root=${param#root=}             ;;
    rootdelay=* ) rootdelay=${param#rootdelay=}   ;;
    rootfstype=*) rootfstype=${param#rootfstype=} ;;
    rootflags=* ) rootflags=${param#rootflags=}   ;;
    resume=*    ) resume=${param#resume=}         ;;
    noresume    ) noresume=true                   ;;
    ro          ) ro="ro"                         ;;
    rw          ) ro="rw"                         ;;
    quiet       ) quiet=1                         ;;
    debug       ) set -x                          ;;
  esac
done

# Initialize udev
echo "Starting udev..."
if [ -x /sbin/udevd ]; then
  UDEVD=/sbin/udevd
elif [ -x /lib/udev/udevd ]; then
  UDEVD=/lib/udev/udevd
elif [ -x /lib/systemd/systemd-udevd ]; then
  UDEVD=/lib/systemd/systemd-udevd
else
  echo "Cannot find udevd"
  UDEVD=
fi

if [ -n "$UDEVD" ]; then
  $UDEVD --daemon --resolve-names=never
  udevadm trigger --action=add
  udevadm settle --timeout=30
  echo "Udev started"
fi

# Initialize device mapper (LVM)
if [ -x /sbin/vgchange ] && [ -d /dev/mapper ]; then
  echo "Activating LVM volumes..."
  /sbin/vgchange -a y >/dev/null 2>&1 && echo "LVM activated"
fi

# Initialize software RAID
if [ -f /etc/mdadm.conf ] && [ -x /sbin/mdadm ]; then
  echo "Assembling RAID arrays..."
  /sbin/mdadm -As >/dev/null 2>&1 && echo "RAID assembled"
fi

# Wait if specified
if [ -n "$rootdelay" ] ; then
  echo "Waiting $rootdelay seconds..."
  sleep "$rootdelay"
fi

# Try resume from hibernation
do_try_resume

# Mount root filesystem
echo "Mounting root filesystem..."
do_mount_root

# Clean up udev
if [ -n "$UDEVD" ]; then
  echo "Stopping udev..."
  udevadm control --exit
  killall -w ${UDEVD##*/} 2>/dev/null || true
fi

# Switch to the real root
echo "Switching to real root filesystem..."
exec switch_root /.root "$init" "$@"

# If switch_root fails
echo "ERROR: switch_root failed!"
problem
